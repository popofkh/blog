---
layout: article
title: iptables详解
date: 2020-12-06 15:27:06
tags: 
	- Linux
---



# iptables基本原理

我们通常所说的`iptables`严格来讲应该叫做`Netfilter`，`Netfilter`是一种内核防火墙框架，可以实现很多网络安全策略，包括数据包过滤、数据包处理、地址伪装、透明代理、网络地址转换等。`iptables`则是一个应用层的二进制工具，可以基于`Netfilter`接口设置内核中的`Netfilter`配置表。

`iptables`由表及构成表的链组成，每条链又由具体的规则组成。iptables内置4张表和5条链，4张表分别是RAW、Mangle、NAT、Filter表，5条链又叫作数据包的5个挂载点（Hook Point，可以理解为回调函数点，在数据包到达这些位置时，内核回主动调用回调函数，使得数据包在路由时可以改变方向或内容），分别是PREROUTING、INPUT、OUTPUT、FORWORD和POSTROUTING。对于不同表中相同类型的规则执行顺序，iptabels定义了优先级，该优先级由高到低排序为raw、managle、nat、filter。例如，对于PREROUTING链来说，首先执行raw表的规则，然后执行mangle表的规则，最后执行nat表的规则。

1、Filter表

Filter表表示iptables的默认表，如果在创建规则时未指定表，那么默认使用Filter表，主要用于数据包过滤，根据具体规则决定是否放行该数据包（DROP、ACCEPT、REJECT、LOG）。

Filter表包含如下三种内建链：

* INPUT链：过滤目的地址是本机的所有数据包
* OUTPUT链：过滤本机产生的所有数据包
* FORWARD链：过滤经过本机的所有数据包（源地址和目的地址都不是本机）

2、NAT表

NAT表主要用于修改数据包的IP地址、端口号等信息，包含以下三种内建链

* PREROUTING链：DNAT，处理刚到达本机并在路由转发前转换数据包的目的地址
* POSTROUTING链：SNAT，处理即将离开本机的数据包，转换数据包的源地址
* OUTPUT链：MASQUERADE，改变本机产生的数据包的源地址

3、Mangle表

主要用于修改数据包的TOS、TTL，以及为数据包设置Mark标记，以实现QoS调整及策略路由等。它包含所有5条内置规则链：PREROUTING、POSTROUTING、INPUT、OUTPUT、FORWORD。

4、RAW表

RAW表是iptables在1.2.9版本之后新增的表，主要用于决定数据包是否被状态跟踪机制处理。RAW表的优先级要优于其他表，包含两条规则链：OUTPUT和PREROUTING。

下图是iptables规则链处理数据包的时机，网卡接收的数据包会进入内核协议栈被PREROUTING规则链处理（是否进行目的地址转换），之后由内核协议栈进行路由选择，如果数据包的目的地址是本机，则内核协议栈会将其传给INPUT链处理，INPUT链在允许通过后，数据包由内核空间进入用户空间，被主机进程处理；如果PREROUTING链处理后的数据报的目的地址不是本机地址，则将其传给FORWARD链进行处理，最后交给POSTROUTING链。本机进程发出的数据包首先进行路由选择，然后经过OUTPUT链，然后到达POSTROUTING链，这时的数据源地址可能已经做过转换了。

# iptables的规则设置

iptables的语法格式为

```shell
iptables [-t 表名] 管理选项 [链名] [条件匹配] [-j 目标动作或跳转]
```

如果不指定表名，则默认使用filter表；如果不指定链名，则默认设置该表的所有链。

iptables命令的参数解释如下所示：

* [-t 表名]：制定操作哪个表，默认为filter表
* -A：在规则链的最后新加一条规则
* -I：插入一条规则，原本在该位置的规则向后移动，如果没有指定编号，则默认为1
* -R：替换某条规则，不会该百年其所在规则链的顺序
* -P：设置某条规则的默认动作
* -N：创建一条新的规则链
* -nL：查看当前的规则列表
* 





# 参考文献

《云原生服务网格Istio原理、实践、架构与源码解析》https://book.douban.com/subject/34438220/




